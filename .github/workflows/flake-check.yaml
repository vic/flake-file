name: flake-check
on:
  push:
    branches: ["main"]
  pull_request:
jobs:
  find-templates:
    name: Find templates
    runs-on: ubuntu-latest
    outputs:
      templates: ${{ steps.templates.outputs.templates }}
    steps:
      - uses: actions/checkout@v4
      - id: templates
        run: |
          templates=$(find templates -mindepth 2 -maxdepth 2  -name flake.nix -print0 | xargs -0 dirname | xargs -n 1 basename | jq -R | jq -sc)
          echo "$templates"
          echo "templates=$templates" >> $GITHUB_OUTPUT
  template:
    name: Check template ${{matrix.template}}
    needs: [find-templates]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        template: ${{ fromJSON(needs.find-templates.outputs.templates) }}
    steps:
      - uses: wimpysworld/nothing-but-nix@main
      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main
      - run: |
          set -uveo pipefail
          cat <<EOF | tee forced.nix
          { lib, ... }:
          {
            flake-file.inputs.flake-file.url = lib.mkForce "github:$GITHUB_REPOSITORY/$GITHUB_SHA";
          }
          EOF
          mkdir templated; cd templated
          nix flake init -t github:$GITHUB_REPOSITORY/$GITHUB_SHA#${{ matrix.template }}
          nix run .#write-flake -L --show-trace
          if test -d ./modules; then cp ../forced.nix ./modules/; fi;
          if test -d ./flake-parts; then cp ../forced.nix ./flake-parts/; fi;
          nix run .#write-flake -L --show-trace && nix run .#write-flake -L --show-trace
          nix flake check -L --show-trace
  dev:
    name: Check flake dev
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: wimpysworld/nothing-but-nix@main
      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main
      - run: nix flake check ./dev -L --override-input flake-file $PWD
  nix-fmt:
    name: Nix Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: wimpysworld/nothing-but-nix@main
      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main
      - run: nix run -L --override-input flake-file $PWD ./dev#fmt -- --ci
