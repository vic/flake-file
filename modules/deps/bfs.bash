# BFS: consume QUEUE_FILE, fetch each new item, discover transitive deps.
bfs_main() {
  log_info "starting BFS..."
  local count=0
  while true; do
    local name="" url=""
    while IFS=$'\t' read -r qname qurl; do
      if ! grep -qxF "$qname" "$SEEN_FILE" 2>/dev/null \
        && ! grep -qxF "$qname" "$FOLLOWS_FILE" 2>/dev/null; then
        name="$qname" url="$qurl"
        break
      fi
    done < "$QUEUE_FILE"
    [ -z "$name" ] && break
    printf '%s\n' "$name" >> "$SEEN_FILE"
    local entry
    entry=$(fetch_entry "$name" "$url") \
      && { printf '%s\n' "$entry" >> "$DEPS_FILE"; count=$((count + 1)); } \
      || true
    discover_transitive "$name" "$url"
  done
  log_info "done: $count inputs fetched"
}

# Write deps.nix from accumulated DEPS_FILE lines.
write_deps_nix() {
  {
    printf '# DO-NOT-EDIT: Generated by github:vic/flake-file\n'
    printf '# To re-generate: nix-shell . -A flake-file.sh --run write-deps\n'
    printf '# Usage: let deps = import ./deps.nix; in deps.nixpkgs.outPath\n'
    printf '{\n'
    cat "$DEPS_FILE"
    printf '}\n'
  } > deps.nix
  log_info "wrote deps.nix"
}
